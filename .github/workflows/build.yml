name: Build MiniOrange Application

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯ï¼Œæˆ–è€…æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

# ğŸ”¥ å¿…é¡»æ·»åŠ å†™æƒé™ï¼Œå¦åˆ™æ— æ³•åˆ›å»º Release å’Œ Tag
permissions:
  contents: write

jobs:
  # 1. æ–°å¢ä»»åŠ¡ï¼šæå–ç‰ˆæœ¬å· (ç±»ä¼¼å‰ç«¯è¯»å– package.json)
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Extract Version from main.py
        id: get_version
        shell: python
        run: |
          import re, os
          with open("main.py", "r", encoding="utf-8") as f:
              content = f.read()
          # æ­£åˆ™åŒ¹é… "version": "x.x.x"
          match = re.search(r'"version":\s*"([^"]+)"', content)
          version = match.group(1) if match else "0.0.0"
          print(f"Detected version: {version}")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              print(f"version={version}", file=fh)

  build:
    needs: check-version
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # åŒæ—¶åœ¨ Windows å’Œ macOS ä¸Šè¿è¡Œ
        os: [windows-latest, macos-latest]

    steps:
    # 1. æ‹‰å–ä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. è®¾ç½® Python ç¯å¢ƒ (å»ºè®®ä½¿ç”¨ 3.10 æˆ– 3.11 ä»¥ä¿è¯ä¾èµ–åº“å…¼å®¹æ€§)
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
        cache: 'pip' # å¼€å¯ pip ç¼“å­˜ï¼ŒåŠ å¿«ä¾èµ–å®‰è£…é€Ÿåº¦

    # 3. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 4. æ‰§è¡Œæ‰“åŒ…è„šæœ¬ (è°ƒç”¨ä½ å†™çš„ build.py)
    - name: Run Build Script
      run: |
        python build.py

    # 5. å‹ç¼©æ‰“åŒ…ç»“æœ (Windows)
    # å°† dist/main.exe å‹ç¼©ä¸º autobots-win-amd64.zip
    - name: Zip Build (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        powershell Compress-Archive -Path dist/MiniOrangeServer_v* -DestinationPath miniorange-win-amd64.zip

    # 6. å‹ç¼©æ‰“åŒ…ç»“æœ (macOS)
    # å°† dist/MiniOrangeServer_v* (æ–‡ä»¶å¤¹) å‹ç¼©ä¸º miniorange-macos-arm64.zip
    - name: Zip Build (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        cd dist
        zip -r ../miniorange-macos-arm64.zip MiniOrangeServer_v*
        cd ..

    # 7. ä¸Šä¼  Artifact (ä¾› Release ä»»åŠ¡ä½¿ç”¨)
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ matrix.os }}
        path: miniorange-*.zip
        retention-days: 1

  release:
    needs: [build, check-version]
    runs-on: ubuntu-latest
    # ä»…å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶æ‰å‘å¸ƒï¼Œé¿å…å¼€å‘åˆ†æ”¯é¢‘ç¹å‘å¸ƒ
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          # ğŸ”¥ ä½¿ç”¨ check-version ä»»åŠ¡æå–åˆ°çš„ç‰ˆæœ¬å·
          tag_name: v${{ needs.check-version.outputs.version }}
          name: Release v${{ needs.check-version.outputs.version }}
          draft: false
          prerelease: false
          make_latest: true
          files: |
            artifacts/miniorange-win-amd64.zip
            artifacts/miniorange-macos-arm64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}