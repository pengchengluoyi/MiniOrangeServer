name: Build MiniOrange Application

# 触发条件：推送到 main 分支，或者手动触发
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # 同时在 Windows 和 macOS 上运行
        os: [windows-latest, macos-latest]

    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. 设置 Python 环境 (建议使用 3.10 或 3.11 以保证依赖库兼容性)
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
        cache: 'pip' # 开启 pip 缓存，加快依赖安装速度

    # 3. 安装依赖
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 4. 执行打包脚本 (调用你写的 build.py)
    - name: Run Build Script
      run: |
        python build.py

    # 5. 压缩打包结果 (Windows)
    # 将 dist/main.exe 压缩为 autobots-win-amd64.zip
    - name: Zip Build (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        powershell Compress-Archive -Path dist/main.exe -DestinationPath miniorange-win-amd64.zip

    # 6. 压缩打包结果 (macOS)
    # 将 dist/main (二进制文件) 压缩为 miniorange-macos-arm64.zip
    - name: Zip Build (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        cd dist
        zip ../miniorange-macos-arm64.zip main
        cd ..

    # 7. 上传 Artifact (供 Release 任务使用)
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ matrix.os }}
        path: miniorange-*.zip
        retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    # 仅当推送到 main 分支时才发布，避免开发分支频繁发布
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          # 使用 "latest" 标签，或者你可以根据日期生成标签
          tag_name: latest
          name: Latest Build
          draft: false
          prerelease: false
          files: |
            artifacts/miniorange-win-amd64.zip
            artifacts/miniorange-macos-arm64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}